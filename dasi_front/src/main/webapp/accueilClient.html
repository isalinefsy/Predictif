<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Predict'IF</title>
    <link rel="stylesheet" type="text/css" href="css/common.css">
    <link rel="stylesheet" type="text/css" href="css/accueilClient.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>Predict'IF <img src="images/predict_if.png" alt="logo" class="logo-img"></h1>
            </div>
            <nav>
                <a href="#medium" class="nav-link">Accueil</a>
                <a href="#compte" class="nav-link">Mon Compte</a>
                <a href="#profil" class="nav-link">Profil Astral</a>
                <a href="#historique" class="nav-link">Historique</a>
                <a href="#deconnexion" class="nav-link" id="logoutLink">Déconnexion</a>
            </nav>
        </div>
    </header>

    <p id="notification"></p>

    <main class="container">
        <div id="medium" class="page-section section">
            <h3>Liste des Médiums</h3>
            <ul id="liste-mediums"></ul> <!-- Section médium pour afficher les médiums -->
        </div>
        <div id="compte" class="page-section section">
            <h3>Informations du Compte</h3>
            <p>Nom : <span id="userLastName"></span></p>
            <p>Prénom : <span id="userFirstName"></span></p>
            <p>Email : <span id="userEmail"></span></p>
            <p>Date de naissance : <span id="userBirthdate"></span></p>
            <p>Adresse postale : <span id="userAddress"></span></p>
            <p>Téléphone : <span id="userPhone"></span></p>
        </div>
        <div id="profil" class="page-section section">
            <h3>Profil Astral</h3>
            <p>Animal Totem : <span id="animalTotem"></span></p>
            <p>Couleur Porte-Bonheur : <span id="couleurPorteBonheur"></span></p>
            <p>Signe Astro Chinois : <span id="signeAstroChinois"></span></p>
            <p>Signe Zodiaque : <span id="signeZodiaque"></span></p>
        </div>
        <div id="historique" class="page-section section">
            <h3>Historique des Consultations</h3>
            <h4>Consultations en attente</h4>
            <ul id="consultationsEnAttente"></ul>
            <h4>Consultations en cours</h4>
            <ul id="consultationsEnCours"></ul>
            <h4>Consultations terminées</h4>
            <ul id="consultationsTerminees"></ul>
        </div>
    </main>

    <script>
        $(document).ready(function () {
            $('#deconnexion').click(function (e) {
                e.preventDefault();
                deconnecterUtilisateur();
                clearClientData();
            });

            $('.nav-link').click(function (e) {
                e.preventDefault();
                var target = $(this).attr('href').substring(1);
                $('.page-section').hide();
                $('#' + target).show();

                if (target === 'medium') {
                    loadMediums();
                } else if (clientData) {
                    displayData(target);
                }
            });

            $('#logoutLink').click(function (e) {
                e.preventDefault();
                deconnecterUtilisateur();
            });

            loadInitialData();

            // Afficher la section 'medium' par défaut
            $('#medium').show();
            loadMediums();
        });

        function deconnecterUtilisateur() {
            $.ajax({
                url: './ActionServlet',
                method: 'POST',
                data: { todo: 'deconnexion' },
                dataType: 'json'
            }).done(function (response) {
                if (response.success) {
                    $('#notification').html(response.message);
                    clearClientData();
                    setTimeout(function () {
                        location.reload(true);
                        window.location.href = "index.html";
                    }, 2000);
                } else {
                    $('#notification').html("Erreur lors de la tentative de déconnexion.");
                }
            }).fail(function () {
                $('#notification').html("Erreur lors de l'appel au serveur pour la déconnexion.");
            });
        }

        function demanderConsultation(idMedium) {
            $('#notification').html("Demande de consultation en cours...");
            $.ajax({
                url: './ActionServlet',
                method: 'POST',
                data: { todo: 'demanderConsultation', idMedium: idMedium },
                dataType: 'json'
            }).done(function (response) {
                if (response.unConnected) {
                    $('#notification').html("Veuillez vous connecter pour prendre un RDV.");
                } else if (response.statut) {
                    $('#notification').html("Demande de consultation réussie.");
                    setTimeout(function () {
                        location.reload();
                    }, 1000);
                } else {
                    $('#notification').html("Problème lors de la demande, veuillez réessayer.");
                }
            }).fail(function () {
                $('#notification').html("Erreur lors de l'appel AJAX.");
            });
        }

        var clientData = null;

        function loadInitialData() {
            $.ajax({
                url: './ActionServlet',
                method: 'POST',
                data: { todo: 'obtenirProfilClient' },
                dataType: 'json'
            }).done(function (response) {
                clientData = response;
                displayData('compte');
                $('#nomClient').html(response.infosClient.prenom + " " + response.infosClient.nom);
                // Afficher la section 'medium' par défaut après le chargement des données
                $('#medium').show();
                loadMediums();
            }).fail(function () {
                alert("Erreur lors du chargement des données.");
                window.location.href = "login.html";
            });
        }

        function loadMediums() {
            $.ajax({
                url: './ActionServlet',
                method: 'POST',
                data: { todo: 'listerMediums' },
                dataType: 'json'
            }).done(function (response) {
                let mediums = response.mediums;
                let listeMediumsHtml = $('#liste-mediums');
                listeMediumsHtml.empty();
                $.each(mediums, function (i, medium) {
                    let listItem = $("<li>").attr("id", medium.id).text(medium.denomination + " " + medium.genre + " " + medium.presentation);
                    let rdvButton = $("<button>").text("Prendre RDV").on("click", function () {
                        demanderConsultation(medium.id);
                    });
                    listItem.append(rdvButton);
                    listeMediumsHtml.append(listItem);
                });
            }).fail(function () {
                alert("Erreur lors du chargement de la liste des médiums.");
            });
        }

        function displayData(section) {
            if (section === 'compte' || section === 'profil' || section === 'historique') {
                var infos = clientData.infosClient;
                $('#userLastName').text(infos.nom);
                $('#userFirstName').text(infos.prenom);
                $('#userEmail').text(infos.mail);
                $('#userBirthdate').text(infos.dateNaissance);
                $('#userAddress').text(infos.adresse);
                $('#userPhone').text(infos.tel);
                $('#animalTotem').text(infos.animalTotem);
                $('#couleurPorteBonheur').text(infos.couleurPorteBonheur);
                $('#signeAstroChinois').text(infos.signeAstroChinois);
                $('#signeZodiaque').text(infos.signeZodiaque);

                // Vider les listes avant de les remplir
                $('#consultationsEnAttente').empty();
                $('#consultationsEnCours').empty();
                $('#consultationsTerminees').empty();
                console.log("Nombre de consultations " + clientData.historiqueConsultation.length);
                // Ajouter chaque consultation à la liste appropriée
                clientData.historiqueConsultation.forEach(function (consult) {
                    // Utiliser console.log pour afficher les informations de la consultation

                    console.log("ID consultation : " + consult.idConsultation);
                    console.log("Date : " + consult.date);
                    console.log("Medium : " + consult.medium);
                    console.log("Etat : " + consult.etat);
                    let consultItem = $('<li>').text(consult.date + " : " + consult.medium);
                    switch (consult.etat) {
                        case 'En attente':
                            $('#consultationsEnAttente').append(consultItem.clone());
                            break;
                        case 'Terminée':
                            $('#consultationsTerminees').append(consultItem.clone());
                            break;
                        case 'En cours':
                            $('#consultationsEnCours').append(consultItem.clone());
                            break;
                    }
                });

                // Ajouter un message si les listes sont vides
                if ($('#consultationsEnAttente').children().length === 0) {
                    $('#consultationsEnAttente').append($('<li>').text("Aucune consultation en attente."));
                }
                if ($('#consultationsEnCours').children().length === 0) {
                    $('#consultationsEnCours').append($('<li>').text("Aucune consultation en cours."));
                }
                if ($('#consultationsTerminees').children().length === 0) {
                    $('#consultationsTerminees').append($('<li>').text("Aucune consultation terminée."));
                }
            }
        }

        function clearClientData() {
            localStorage.clear();
        }
    </script>
</body>
</html>
