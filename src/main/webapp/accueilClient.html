<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <title>Predict'IF</title>

        <style>
            body, html {
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
            }
            header {
                background-color: #f4f4f4;
                padding: 10px 20px;
                text-align: center;
            }
            nav a {
                margin: 0 10px;
                text-decoration: none;
                color: #333;
            }
            .page-section {
                display: none; /* Cache toutes les sections par défaut */
            }
            footer {
                background-color: #222;
                color: white;
                text-align: center;
                padding: 10px 0;
                position: fixed;
                bottom: 0;
                width: 100%;
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    </head>
    <body>
        <header>
            <h1>Bienvenue !</h1>  
            <p id="nomClient"></p>
            <nav>
                <a href="#compte" class="nav-link">Mon Compte</a>
                <a href="#profil" class="nav-link">Profil Astral</a>
                <a href="#historique" class="nav-link">Historique</a>
                <a href="#deconnexion" class="nav-link" id="logoutLink">Déconnexion</a>
            </nav>
        </header>

        <h2> Liste des Médiums </h2>
        <ul id="liste-mediums"></ul> <!-- Toujours visible, indépendamment des sections -->
        <p id="notification"></p>

        <main>
            <div id="compte" class="page-section">
                <h3>Informations du Compte</h3>
                <p>Nom : <span id="userLastName"></span></p>
                <p>Prénom : <span id="userFirstName"></span></p>
                <p>Email : <span id="userEmail"></span></p>
                <p>Date de naissance : <span id="userBirthdate"></span></p>
                <p>Adresse postale : <span id="userAddress"></span></p>
                <p>Téléphone : <span id="userPhone"></span></p>
            </div>
            <div id="profil" class="page-section">
                <h3>Profil Astral</h3>
                <p>Animal Totem : <span id="animalTotem"></span></p>
                <p>Couleur Porte-Bonheur : <span id="couleurPorteBonheur"></span></p>
                <p>Signe Astro Chinois : <span id="signeAstroChinois"></span></p>
                <p>Signe Zodiaque : <span id="signeZodiaque"></span></p>
            </div>
            <div id="historique" class="page-section">
                <h3>Historique des Consultations</h3>
                <h4>Consultations en attente</h4>
                <ul id="consultationsEnAttente"></ul>
                <h4>Consultations en cours</h4>
                <ul id="consultationsEnCours"></ul>
                <h4>Consultations terminées</h4>
                <ul id="consultationsTerminees"></ul>
            </div>


        </main>

        <footer>
            <p>© 2024 Predict'IF. Tous droits réservés.</p>
        </footer>

        <script>
            // Ajout d'un écouteur d'événements pour le lien de déconnexion
            $(document).ready(function () {
                $('#deconnexion').click(function (e) {
                    e.preventDefault();  // Empêcher le comportement par défaut du lien
                    deconnecterUtilisateur();  // Appeler la fonction de déconnexion
                    clearClientData(); //s'assure que les données sont bien effacées coté client aussi 
                });
            });

            function deconnecterUtilisateur() {
                $.ajax({
                    url: './ActionServlet', // URL de votre servlet de déconnexion
                    method: 'POST',
                    data: {
                        todo: 'deconnexion',
                    },
                    dataType: 'json'
                }).done(function (response) {
                    // Afficher une notification sur la page
                    if (response.success) {
                        $('#notification').html(response.message);
                        // Attendre 2 secondes avant de rediriger
                        setTimeout(function () {
                            window.location.href = "index.html";  // Redirige vers la page d'accueil
                        }, 2000);
                    } else {
                        $('#notification').html("Erreur lors de la tentative de déconnexion.");
                    }
                }).fail(function () {
                    $('#notification').html("Erreur lors de l'appel au serveur pour la déconnexion.");
                });
            }
            function demanderConsultation(idMedium) {
                $('#notification').html("Demande de consultation en cours...");
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'demanderConsultation',
                        idMedium: idMedium
                    },
                    dataType: 'json'
                }).done(function (response) {
                    if (response.unConnected) {
                        $('#notification').html("Veuillez vous connecter pour prendre un RDV.");
                    } else if (response.statut) {
                        $('#notification').html("Demande de consultation réussie.");
                    } else {
                        $('#notification').html("Problème lors de la demande, veuillez réessayer.");
                    }
                }).fail(function () {
                    $('#notification').html("Erreur lors de l'appel AJAX.");
                });
            }
            var clientData = null;

            $(document).ready(function () {
                loadInitialData();
                loadMediums(); // Assure le chargement de la liste des médiums

                $('.nav-link').click(function (e) {
                    e.preventDefault();
                    var target = $(this).attr('href').substring(1);
                    $('.page-section').hide();
                    $('#' + target).show();

                    if (clientData) {
                        displayData(target);
                    }
                });
                // Gestionnaire de clic pour le lien de déconnexion
                $('#logoutLink').click(function (e) {
                    e.preventDefault();  // Empêcher le comportement par défaut du lien
                    deconnecterUtilisateur();  // Appeler la fonction de déconnexion
                });
            });

            function loadMediums() {
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'listerMediums',
                    },
                    dataType: 'json'
                }).done(function (response) {
                    let mediums = response.mediums;
                    let listeMediumsHtml = $('#liste-mediums');
                    listeMediumsHtml.empty();
                    $.each(mediums, function (i, medium) {
                        let listItem = $("<li>").attr("id", medium.id).text(medium.denomination + " " + medium.genre + " " + medium.presentation);
                        let rdvButton = $("<button>").text("Prendre RDV").on("click", function () {
                            demanderConsultation(medium.id);
                        });
                        listItem.append(rdvButton);
                        listeMediumsHtml.append(listItem);
                    });
                }).fail(function () {
                    alert("Erreur lors du chargement de la liste des médiums.");
                });
            }

            function loadInitialData() {
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'obtenirProfilClient',
                    },
                    dataType: 'json'
                }).done(function (response) {
                    clientData = response;
                    displayData('compte'); // Display 'compte' by default or based on URL hash
                    $('#nomClient').html(response.infosClient.prenom + " " + response.infosClient.nom); // Display name in header
                }).fail(function () {
                    alert("Erreur lors du chargement des données.");
                });
            }

            function displayData(section) {
                if (section === 'compte' || section === 'profil' || section === 'historique') {
                    // Mettre à jour les informations personnelles et de profil
                    var infos = clientData.infosClient;
                    $('#userLastName').text(infos.nom);
                    $('#userFirstName').text(infos.prenom);
                    $('#userEmail').text(infos.mail);
                    $('#userBirthdate').text(infos.dateNaissance);
                    $('#userAddress').text(infos.adresse);
                    $('#userPhone').text(infos.tel);
                    $('#animalTotem').text(infos.animalTotem);
                    $('#couleurPorteBonheur').text(infos.couleurPorteBonheur);
                    $('#signeAstroChinois').text(infos.signeAstroChinois);
                    $('#signeZodiaque').text(infos.signeZodiaque);

                    // Mettre à jour les listes de consultations
                    $('#consultationsEnAttente').empty();
                    $('#consultationsTerminees').empty();
                    $('#consultationsEnCours').empty();

                    clientData.historiqueConsultation.forEach(function (consult) {
                        let consultItem = $('<li>').text(consult.date + " : " + consult.medium);
                        switch (consult.etat) {
                            case 'En attente':
                                $('#consultationsEnAttente').append(consultItem);
                                break;
                            case 'Terminée':
                                $('#consultationsTerminees').append(consultItem);
                                break;
                            case 'En cours':
                                $('#consultationsEnCours').append(consultItem);
                                break;
                        }
                    });

                    // Gérer le cas où les listes sont vides après l'itération
                    if ($('#consultationsEnAttente').children().length === 0) {
                        $('#consultationsEnAttente').append($('<li>').text("Aucune consultation en attente."));
                    }
                    if ($('#consultationsTerminees').children().length === 0) {
                        $('#consultationsTerminees').append($('<li>').text("Aucune consultation terminée."));
                    }
                    if ($('#consultationsEnCours').children().length === 0) {
                        $('#consultationsEnCours').append($('<li>').text("Aucune consultation en cours."));
                    }
                }
            }
            function clearClientData() {
                localStorage.clear(); // Effacer toutes les données stockées localement
                sessionStorage.clear(); // Effacer les données de la session
            }

            window.onload = function () {
                if (performance.navigation.type == 2) { // Le type 2 correspond à la navigation par le bouton retour
                    window.location.reload(true); // Force le rechargement de la page depuis le serveur
                }
            };

        </script>
    </body>
</html>
